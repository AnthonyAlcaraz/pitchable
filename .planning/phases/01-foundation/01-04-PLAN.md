---
phase: 01-foundation
plan: 04
type: execute
wave: 1
depends_on: []
files_modified:
  - src/constraints/density-validator.ts
  - src/constraints/typography-validator.ts
  - src/constraints/layout-validator.ts
  - src/constraints/constraints.service.ts
  - src/constraints/index.ts
autonomous: true

must_haves:
  truths:
    - "A slide with 7 bullets is rejected with a violation message mentioning 'max 6'"
    - "A bullet with 11+ words is rejected with a violation message mentioning 'max 10 words per bullet'"
    - "A slide using Comic Sans is rejected as a banned font"
    - "A slide with body font at 20pt is rejected (min 24pt)"
    - "A slide with 4 distinct colors is rejected (max 3 per slide)"
    - "A slide with 3 columns is rejected (max 2)"
    - "A slide with full-bleed text and 20% overlay is rejected (min 30%)"
    - "A slide with 4 distinct font sizes is rejected (max 3)"
  artifacts:
    - path: "src/constraints/layout-validator.ts"
      provides: "Layout rules: max columns, max font sizes, max colors, overlay check"
      contains: "validateLayout"
    - path: "src/constraints/density-validator.ts"
      provides: "Updated density validator with maxBullets=6 and maxWordsPerBullet=10"
      contains: "maxWordsPerBullet"
    - path: "src/constraints/typography-validator.ts"
      provides: "Updated typography with min body 24pt and banned fonts list"
      contains: "BANNED_FONTS"
  key_links:
    - from: "src/constraints/constraints.service.ts"
      to: "src/constraints/layout-validator.ts"
      via: "import and validateLayout call"
      pattern: "validateLayout"
    - from: "src/constraints/index.ts"
      to: "src/constraints/layout-validator.ts"
      via: "barrel export"
      pattern: "layout-validator"
---

<objective>
Fix existing design constraint validators (density limits, typography minimums) and create the missing layout validator (DC-06) to complete the design constraint engine.

Purpose: The constraint engine is the core differentiator of Pitchable -- it prevents ugly slides at generation time. Three gaps exist: (1) density limits use wrong constants, (2) typography minimums are too low, (3) layout rules (DC-06) don't exist yet. This plan closes all three gaps.

Output: Complete design constraint engine covering DC-01 through DC-07 with correct constants and a new layout validator.
</objective>

<execution_context>
@C:\Users\33641\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\33641\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/research/PHASE1-RESEARCH.md
@src/constraints/density-validator.ts
@src/constraints/typography-validator.ts
@src/constraints/constraints.service.ts
@src/constraints/color-validator.ts
@src/constraints/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix density and typography constants, add banned fonts</name>
  <files>
    src/constraints/density-validator.ts
    src/constraints/typography-validator.ts
  </files>
  <action>
    1. UPDATE `src/constraints/density-validator.ts`:
       a. Change `maxBulletsPerSlide` from 5 to 6 (requirement DC-05 says max 6 bullets)
       b. Add `maxWordsPerBullet: 10` to the DENSITY_LIMITS constant
       c. Add a new validation check in `validateSlideContent()` for per-bullet word count:
          - Parse each bullet line from the body
          - Count words in each bullet line
          - If any bullet exceeds 10 words, add violation: `Bullet "${truncated}" has ${wordCount} words (max 10 per bullet).`
          - Add suggestion: `Shorten bullet to key phrases. Move details to speaker notes.`
       d. Update `suggestSplit()` to use the new maxBulletsPerSlide of 6

    2. UPDATE `src/constraints/typography-validator.ts`:
       a. Change `FONT_SIZE_MINIMUMS.body` from 18 to 24 (requirement DC-03 says "min 24pt body")
       b. Add a `BANNED_FONTS` constant array: `['Comic Sans MS', 'Comic Sans', 'Papyrus', 'Bradley Hand', 'Curlz MT', 'Jokerman', 'Impact']`
       c. Update `validateFontChoice()` to FIRST check against BANNED_FONTS before checking the whitelist:
          - If font matches a banned font (case-insensitive), return `{ valid: false, suggestion: undefined, banned: true, reason: 'Font "${font}" is banned for professional presentations.' }`
          - Update the FontValidationResult interface to include optional `banned?: boolean` and `reason?: string` fields
       d. Keep the existing whitelist check as the second validation step (font must be in ALLOWED_FONTS)

    3. Verify the constants are correct:
       - maxBulletsPerSlide: 6 (was 5)
       - maxWordsPerBullet: 10 (new)
       - maxWordsPerSlide: 80 (unchanged)
       - FONT_SIZE_MINIMUMS.body: 24 (was 18)
       - FONT_SIZE_MINIMUMS.heading: 28 (unchanged)
       - BANNED_FONTS includes all 7 fonts from DC-03
  </action>
  <verify>
    - `npm run build` succeeds
    - `grep "maxBulletsPerSlide: 6" src/constraints/density-validator.ts` finds the updated value
    - `grep "maxWordsPerBullet: 10" src/constraints/density-validator.ts` finds the new limit
    - `grep "body: 24" src/constraints/typography-validator.ts` finds updated minimum
    - `grep "Comic Sans" src/constraints/typography-validator.ts` finds banned font
  </verify>
  <done>Density limits updated (maxBullets 5->6, added maxWordsPerBullet 10). Typography updated (min body 18->24pt, banned fonts list added with 7 entries).</done>
</task>

<task type="auto">
  <name>Task 2: Create layout validator (DC-06) and wire into constraints service</name>
  <files>
    src/constraints/layout-validator.ts
    src/constraints/constraints.service.ts
    src/constraints/index.ts
  </files>
  <action>
    1. CREATE `src/constraints/layout-validator.ts` following the pattern from PHASE1-RESEARCH.md:
       ```typescript
       export interface LayoutConfig {
         columns: number;
         fontSizesUsed: number[];
         colorsUsed: string[];
         hasFullBleedText: boolean;
         overlayOpacity?: number;  // 0-100 percentage
       }

       export interface LayoutValidationResult {
         valid: boolean;
         violations: string[];
       }

       export const LAYOUT_LIMITS = {
         maxColumns: 2,
         maxDistinctFontSizes: 3,
         maxDistinctColors: 3,
         minOverlayOpacity: 30,  // % overlay required for full-bleed text
       } as const;

       export function validateLayout(layout: LayoutConfig): LayoutValidationResult {
         const violations: string[] = [];

         if (layout.columns > LAYOUT_LIMITS.maxColumns) {
           violations.push(
             `Layout uses ${layout.columns} columns (max ${LAYOUT_LIMITS.maxColumns}).`
           );
         }

         const uniqueSizes = [...new Set(layout.fontSizesUsed)];
         if (uniqueSizes.length > LAYOUT_LIMITS.maxDistinctFontSizes) {
           violations.push(
             `Slide uses ${uniqueSizes.length} distinct font sizes (max ${LAYOUT_LIMITS.maxDistinctFontSizes}).`
           );
         }

         const uniqueColors = [...new Set(layout.colorsUsed.map(c => c.toLowerCase()))];
         if (uniqueColors.length > LAYOUT_LIMITS.maxDistinctColors) {
           violations.push(
             `Slide uses ${uniqueColors.length} distinct colors (max ${LAYOUT_LIMITS.maxDistinctColors}).`
           );
         }

         if (layout.hasFullBleedText) {
           const opacity = layout.overlayOpacity ?? 0;
           if (opacity < LAYOUT_LIMITS.minOverlayOpacity) {
             violations.push(
               `Full-bleed text without sufficient overlay (${opacity}%, min ${LAYOUT_LIMITS.minOverlayOpacity}%).`
             );
           }
         }

         return { valid: violations.length === 0, violations };
       }
       ```

    2. UPDATE `src/constraints/constraints.service.ts`:
       - Import `validateLayout`, `LayoutConfig`, `LayoutValidationResult`, `LAYOUT_LIMITS` from './layout-validator'
       - Add `validateLayout(layout: LayoutConfig): LayoutValidationResult` method that delegates to the validator function
       - The existing `validateSlide()` method should also call layout validation when layout config is available

    3. UPDATE `src/constraints/index.ts`:
       - Add barrel exports for layout-validator: `export * from './layout-validator'`
       - Ensure validateSlideDesign still works (may need to be updated if it now includes layout validation)
       - If validateSlideDesign in index.ts takes a SlideTheme, consider adding an optional LayoutConfig parameter

    4. `npm run build` to verify everything compiles.
  </action>
  <verify>
    - `npm run build` succeeds
    - `ls src/constraints/layout-validator.ts` exists
    - `grep "validateLayout" src/constraints/constraints.service.ts` finds the method
    - `grep "layout-validator" src/constraints/index.ts` finds the export
    - The following test cases should hold (verify mentally or via quick script):
      - validateLayout({ columns: 3, fontSizesUsed: [12, 14], colorsUsed: ['#000'], hasFullBleedText: false }) -> violations include "3 columns"
      - validateLayout({ columns: 1, fontSizesUsed: [12, 14, 16, 18], colorsUsed: ['#000'], hasFullBleedText: false }) -> violations include "4 distinct font sizes"
      - validateLayout({ columns: 1, fontSizesUsed: [12], colorsUsed: ['#000', '#fff', '#ccc', '#aaa'], hasFullBleedText: false }) -> violations include "4 distinct colors"
      - validateLayout({ columns: 1, fontSizesUsed: [12], colorsUsed: ['#000'], hasFullBleedText: true, overlayOpacity: 20 }) -> violations include "20%"
  </verify>
  <done>Layout validator created (DC-06) with max 2 columns, max 3 font sizes, max 3 colors, min 30% overlay. Wired into ConstraintsService and barrel-exported from index.ts.</done>
</task>

</tasks>

<verification>
1. `npm run build` -- no TypeScript errors
2. All DC requirement constants are correct:
   - DC-01: WCAG contrast ratios (unchanged, already correct in color-validator.ts)
   - DC-02: Banned color pairs (unchanged, already correct)
   - DC-03: Min body 24pt (updated), banned fonts (added), max 2 fonts (unchanged), sans-serif only (unchanged via whitelist)
   - DC-04: Banned font pairings (unchanged, already correct)
   - DC-05: Max 6 bullets (updated from 5), max 10 words/bullet (new), max 80 words (unchanged)
   - DC-06: Max 2 columns, max 3 font sizes, max 3 colors, min 30% overlay (new file)
   - DC-07: Auto-split (unchanged, already correct)
3. Layout validator exports work: `grep "validateLayout" src/constraints/index.ts`
</verification>

<success_criteria>
- DC-01: WCAG color contrast validation works (existing, unchanged)
- DC-02: Banned color pairs detected (existing, unchanged)
- DC-03: Typography rules enforced with correct minimums (24pt body) and banned fonts list
- DC-04: Banned font pairings detected (existing, unchanged)
- DC-05: Content density limits correct (max 6 bullets, max 10 words/bullet, max 80 words)
- DC-06: Layout rules enforced (max 2 columns, max 3 font sizes, max 3 colors, overlay check)
- DC-07: Auto-split works (existing, unchanged)
- All validators accessible through ConstraintsService
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation/01-04-SUMMARY.md`
</output>
