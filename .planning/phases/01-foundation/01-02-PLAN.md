---
phase: 01-foundation
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - docker-compose.yml
  - prisma/schema.prisma
  - src/prisma/prisma.service.ts
  - src/prisma/prisma.module.ts
  - src/main.ts
  - src/app.module.ts
  - src/common/filters/http-exception.filter.ts
  - src/health/health.controller.ts
  - src/health/health.module.ts
  - src/config/env.validation.ts
  - nest-cli.json
  - .env.example
  - .gitignore
autonomous: true

must_haves:
  truths:
    - "docker compose up starts PostgreSQL 16 with pgvector, Redis 7, and MinIO without errors"
    - "All three Docker services pass their health checks within 30 seconds"
    - "The NestJS app starts with validated environment variables"
    - "OpenAPI/Swagger docs are accessible at /api/docs"
    - "GET /health returns HTTP 200 with database connectivity status"
    - "Invalid requests receive structured JSON error responses with statusCode, timestamp, path, method, message"
    - "Rate limiting rejects excessive requests (> 100/minute)"
  artifacts:
    - path: "docker-compose.yml"
      provides: "PostgreSQL 16 + pgvector, Redis 7, MinIO with health checks"
      contains: "pgvector/pgvector:pg16"
    - path: "prisma/schema.prisma"
      provides: "Updated User model with refreshTokenHash and password reset fields"
      contains: "refreshTokenHash"
    - path: "src/prisma/prisma.service.ts"
      provides: "Prisma 7 service with driver adapter pattern"
      contains: "PrismaPg"
    - path: "src/main.ts"
      provides: "Bootstrap with Swagger, helmet, CORS, ValidationPipe, global filters"
      contains: "SwaggerModule"
    - path: "src/health/health.controller.ts"
      provides: "Health check endpoint using @nestjs/terminus"
    - path: "src/common/filters/http-exception.filter.ts"
      provides: "Global exception filter with structured error responses"
    - path: "src/config/env.validation.ts"
      provides: "Environment variable validation with class-validator"
    - path: "nest-cli.json"
      provides: "Swagger CLI plugin configuration"
      contains: "@nestjs/swagger"
  key_links:
    - from: "src/main.ts"
      to: "src/common/filters/http-exception.filter.ts"
      via: "app.useGlobalFilters()"
      pattern: "useGlobalFilters.*AllExceptionsFilter"
    - from: "src/app.module.ts"
      to: "src/health/health.module.ts"
      via: "module import"
      pattern: "HealthModule"
    - from: "src/app.module.ts"
      to: "@nestjs/throttler"
      via: "ThrottlerModule.forRoot"
      pattern: "ThrottlerModule"
    - from: "src/prisma/prisma.service.ts"
      to: "@prisma/adapter-pg"
      via: "driver adapter constructor"
      pattern: "PrismaPg"
---

<objective>
Upgrade Docker Compose (pgvector + MinIO), fix Prisma 7 driver adapter, update schema for auth fields, and add all backend infrastructure: Swagger, rate limiting, health checks, structured errors, env validation.

Purpose: Creates the infrastructure foundation that every subsequent plan depends on. Docker services run the data layer, Prisma connects properly with Prisma 7 adapter, and the NestJS bootstrap has all production-ready middleware.

Output: Working Docker stack with pgvector + Redis + MinIO, Prisma 7 with proper driver adapter, Swagger at /api/docs, health check at /health, rate limiting, structured error responses, and validated env config.
</objective>

<execution_context>
@C:\Users\33641\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\33641\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/research/PHASE1-RESEARCH.md
@src/prisma/prisma.service.ts
@src/prisma/prisma.module.ts
@src/main.ts
@src/app.module.ts
@docker-compose.yml
@nest-cli.json
@prisma/schema.prisma
</context>

<tasks>

<task type="auto">
  <name>Task 1: Upgrade Docker Compose and fix Prisma 7 service</name>
  <files>
    docker-compose.yml
    prisma/schema.prisma
    src/prisma/prisma.service.ts
    src/prisma/prisma.module.ts
    src/config/env.validation.ts
    .env.example
    .gitignore
  </files>
  <action>
    1. REPLACE `docker-compose.yml` with upgraded version:
       - Change postgres image from `postgres:16-alpine` to `pgvector/pgvector:pg16`
       - Add health checks to postgres: `pg_isready -U slideforge`
       - Add `command: redis-server --appendonly yes` and health check to redis: `redis-cli ping`
       - Add MinIO service:
         - image: `minio/minio:latest`
         - env: MINIO_ROOT_USER=minioadmin, MINIO_ROOT_PASSWORD=minioadmin123
         - ports: 9000:9000 (API), 9001:9001 (Console)
         - volume: miniodata:/data
         - command: `server /data --console-address ":9001"`
         - healthcheck: `["CMD", "mc", "ready", "local"]`
       - Add miniodata to volumes section

    2. UPDATE `prisma/schema.prisma` -- add auth fields to User model:
       - Add `refreshTokenHash String?` field
       - Add `passwordResetToken String?` field
       - Add `passwordResetExpiry DateTime?` field
       - Keep ALL existing fields and models unchanged
       - Do NOT change the generator or datasource blocks

    3. REWRITE `src/prisma/prisma.service.ts` to use Prisma 7 driver adapter pattern:
       ```typescript
       import { Injectable, OnModuleDestroy } from '@nestjs/common';
       import { PrismaClient } from '../../generated/prisma/client.js';
       import { PrismaPg } from '@prisma/adapter-pg';
       import { ConfigService } from '@nestjs/config';

       @Injectable()
       export class PrismaService extends PrismaClient implements OnModuleDestroy {
         constructor(configService: ConfigService) {
           const adapter = new PrismaPg({
             connectionString: configService.get<string>('DATABASE_URL'),
           });
           super({ adapter });
         }

         async onModuleDestroy(): Promise<void> {
           await this.$disconnect();
         }
       }
       ```
       Key changes: Remove OnModuleInit and $connect() (Prisma 7 connects lazily), inject ConfigService, use PrismaPg adapter.

    4. UPDATE `src/prisma/prisma.module.ts` to import ConfigModule if not already:
       - Ensure PrismaModule imports ConfigModule or that ConfigModule is global (it is -- check app.module.ts)
       - Keep the @Global() decorator on PrismaModule

    5. CREATE `src/config/env.validation.ts` with environment validation:
       - Use class-validator decorators: DATABASE_URL (required string), JWT_ACCESS_SECRET (required), JWT_REFRESH_SECRET (required), REDIS_HOST (optional, default localhost), REDIS_PORT (optional, default 6379), PORT (optional, default 3000), MINIO_ENDPOINT (optional), RESEND_API_KEY (optional), FRONTEND_URL (optional)
       - Export a `validate()` function that uses plainToInstance + validateSync
       - This is the pattern from PHASE1-RESEARCH.md Pattern "env.validation.ts"

    6. UPDATE `.env.example` to include all required env vars:
       - DATABASE_URL, JWT_ACCESS_SECRET, JWT_REFRESH_SECRET, REDIS_HOST, REDIS_PORT, PORT, MINIO_ENDPOINT, MINIO_PORT, MINIO_ROOT_USER, MINIO_ROOT_PASSWORD, MINIO_USE_SSL, RESEND_API_KEY, FRONTEND_URL, NODE_ENV

    7. UPDATE `.gitignore` to add:
       - `.env` (if not already there)
       - `apps/web/dist/` for frontend builds

    8. Install new dependencies:
       ```bash
       npm install @prisma/adapter-pg @nestjs/swagger swagger-ui-express @nestjs/throttler @nestjs/terminus helmet resend argon2
       npm install -D @types/express
       npm uninstall bcrypt @types/bcrypt
       ```
       NOTE: argon2 is installed here so it is available for Plan 03 (auth rewrite). bcrypt is removed here because the auth rewrite in Plan 03 will replace all usage.

    9. Run `npx prisma generate` to regenerate the Prisma client with the new schema fields.
  </action>
  <verify>
    - `docker compose up -d` starts all 3 services
    - `docker compose ps` shows postgres, redis, minio all "healthy" (wait ~30s)
    - `cat prisma/schema.prisma | grep refreshTokenHash` finds the new field
    - `cat src/prisma/prisma.service.ts | grep PrismaPg` confirms driver adapter
    - `npm ls @prisma/adapter-pg` shows it's installed
    - `npm ls argon2` shows it's installed
    - `npm ls bcrypt` returns "not found" (removed)
  </verify>
  <done>Docker Compose runs pgvector + Redis + MinIO with health checks. Prisma 7 uses driver adapter. Schema has auth fields. bcrypt removed, argon2 installed.</done>
</task>

<task type="auto">
  <name>Task 2: Add Swagger, rate limiting, health checks, structured errors to NestJS bootstrap</name>
  <files>
    src/main.ts
    src/app.module.ts
    nest-cli.json
    src/common/filters/http-exception.filter.ts
    src/health/health.controller.ts
    src/health/health.module.ts
  </files>
  <action>
    1. CREATE `src/common/filters/http-exception.filter.ts`:
       - Implement AllExceptionsFilter that catches all exceptions
       - Return structured JSON: { statusCode, timestamp, path, method, message, error }
       - Handle both HttpException and unknown exceptions
       - Use the exact pattern from PHASE1-RESEARCH.md Pattern 8

    2. CREATE `src/health/health.module.ts`:
       - Import TerminusModule and PrismaModule
       - Provide HealthController

    3. CREATE `src/health/health.controller.ts`:
       - GET /health endpoint using @HealthCheck() decorator
       - PrismaHealthIndicator.pingCheck('database', this.prisma)
       - Use the exact pattern from PHASE1-RESEARCH.md Pattern 7
       - Decorate with @SkipThrottle() so health checks are not rate limited

    4. UPDATE `nest-cli.json` to add Swagger CLI plugin:
       ```json
       {
         "$schema": "https://json.schemastore.org/nest-cli",
         "collection": "@nestjs/schematics",
         "sourceRoot": "src",
         "compilerOptions": {
           "deleteOutDir": true,
           "plugins": [
             {
               "name": "@nestjs/swagger",
               "options": {
                 "classValidatorShim": true,
                 "introspectComments": true
               }
             }
           ]
         }
       }
       ```

    5. UPDATE `src/app.module.ts`:
       - Add ThrottlerModule.forRoot() with named throttlers:
         - short: 3 req/sec, medium: 20 req/10s, long: 100 req/min
       - Add ThrottlerGuard as APP_GUARD provider
       - Add HealthModule to imports
       - Update ConfigModule.forRoot() to use the validate function from env.validation.ts:
         `ConfigModule.forRoot({ isGlobal: true, validate })`
       - Keep ALL existing imports (PrismaModule, AuthModule, ConstraintsModule, ThemesModule, CreditsModule, PresentationsModule, ImagesModule, ExportsModule)
       - Update BullModule.forRoot to use ConfigService instead of direct process.env

    6. REWRITE `src/main.ts` with full bootstrap:
       ```typescript
       import { NestFactory } from '@nestjs/core';
       import { ValidationPipe } from '@nestjs/common';
       import { SwaggerModule, DocumentBuilder } from '@nestjs/swagger';
       import helmet from 'helmet';
       import { AppModule } from './app.module.js';
       import { AllExceptionsFilter } from './common/filters/http-exception.filter.js';

       async function bootstrap() {
         const app = await NestFactory.create(AppModule);

         // Security
         app.use(helmet());
         app.enableCors({
           origin: process.env.FRONTEND_URL || 'http://localhost:5173',
           credentials: true,
         });

         // Global validation pipe
         app.useGlobalPipes(
           new ValidationPipe({
             whitelist: true,
             forbidNonWhitelisted: true,
             transform: true,
           }),
         );

         // Global exception filter
         app.useGlobalFilters(new AllExceptionsFilter());

         // Swagger / OpenAPI
         const config = new DocumentBuilder()
           .setTitle('Pitchable API')
           .setDescription('Chat-driven AI Presentation Builder')
           .setVersion('1.0')
           .addBearerAuth()
           .build();
         const document = SwaggerModule.createDocument(app, config);
         SwaggerModule.setup('api/docs', app, document);

         await app.listen(process.env.PORT ?? 3000);
       }
       bootstrap();
       ```

    7. Build the project to verify no TypeScript errors:
       ```bash
       npm run build
       ```
  </action>
  <verify>
    - `npm run build` succeeds without TypeScript errors
    - Start the app: `npm run start:dev` (with Docker running)
    - `curl http://localhost:3000/health` returns 200 with JSON health status
    - `curl http://localhost:3000/api/docs` returns Swagger HTML page (200)
    - Send 110 requests in 1 minute to verify rate limiting kicks in (429 response)
    - `curl -X POST http://localhost:3000/nonexistent` returns structured error JSON with statusCode, timestamp, path
  </verify>
  <done>Swagger docs at /api/docs, health check at /health, rate limiting active, structured error responses, ValidationPipe enabled globally, helmet + CORS configured</done>
</task>

</tasks>

<verification>
1. `docker compose up -d && docker compose ps` -- all 3 services healthy
2. `npm run build` -- no TypeScript errors
3. `curl http://localhost:3000/health` -- returns 200 with database check
4. `curl http://localhost:3000/api/docs` -- returns Swagger UI
5. `curl -X POST http://localhost:3000/invalid-route` -- returns structured error with statusCode, timestamp, path, method
6. `cat prisma/schema.prisma | grep -c "refreshTokenHash\|passwordResetToken\|passwordResetExpiry"` -- returns 3
</verification>

<success_criteria>
- INF-01: Docker Compose runs PostgreSQL 16 + pgvector, Redis 7, MinIO
- INF-02: .env validation rejects missing required variables
- INF-03: OpenAPI/Swagger auto-generated docs at /api/docs
- INF-04: ValidationPipe enabled globally (class-validator active)
- INF-05: Rate limiting via @nestjs/throttler (3/sec, 20/10s, 100/min)
- INF-06: Structured error responses with statusCode, timestamp, path, method, message
- INF-07: Health check endpoint at /health with Prisma database check
- Prisma 7 uses driver adapter pattern (no $connect)
- Schema updated with auth fields for Plan 03
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation/01-02-SUMMARY.md`
</output>
