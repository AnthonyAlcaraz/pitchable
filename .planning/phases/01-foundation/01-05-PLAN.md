---
phase: 01-foundation
plan: 05
type: execute
wave: 2
depends_on: ["01-04"]
files_modified:
  - src/themes/themes.service.ts
  - src/themes/themes.controller.ts
  - src/themes/themes.module.ts
  - src/constraints/constraints.service.ts
autonomous: true

must_haves:
  truths:
    - "GET /themes returns 5 built-in themes with validated palettes and font pairings"
    - "GET /themes/:id returns a single theme by ID"
    - "All 5 themes pass design constraint validation (zero violations)"
    - "The creative-warm theme uses a valid font pairing (heading and body from different categories)"
    - "GET /constraints/validate accepts a slide + theme and returns validation results"
  artifacts:
    - path: "src/themes/themes.service.ts"
      provides: "5 built-in themes, all passing constraint validation"
      contains: "BUILT_IN_THEMES"
    - path: "src/themes/themes.controller.ts"
      provides: "Theme API endpoints with Swagger docs"
    - path: "src/constraints/constraints.service.ts"
      provides: "Constraint service with validate-slide endpoint support"
  key_links:
    - from: "src/themes/themes.service.ts"
      to: "src/constraints/constraints.service.ts"
      via: "theme validation on seed"
      pattern: "validatePalette|validateFontPairing"
    - from: "src/themes/themes.controller.ts"
      to: "src/themes/themes.service.ts"
      via: "controller routes"
      pattern: "findAll|findOne"
---

<objective>
Fix the creative-warm theme font pairing, add theme validation proof, and enhance the themes + constraints API endpoints with Swagger documentation.

Purpose: Ensures all 5 built-in themes pass the design constraint engine (DC-08). The creative-warm theme uses Poppins + DM Sans which are both geometric sans-serifs and would fail the pairing validator. This plan fixes that and proves all themes are valid through the constraint engine.

Output: 5 validated themes, all passing constraint checks. Enhanced API endpoints for themes and constraint validation with Swagger documentation.
</objective>

<execution_context>
@C:\Users\33641\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\33641\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/research/PHASE1-RESEARCH.md
@src/themes/themes.service.ts
@src/themes/themes.controller.ts
@src/constraints/constraints.service.ts
@src/constraints/typography-validator.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix creative-warm font pairing and add theme validation</name>
  <files>
    src/themes/themes.service.ts
    src/themes/themes.module.ts
  </files>
  <action>
    1. UPDATE `src/themes/themes.service.ts`:
       a. Fix the creative-warm theme's font pairing:
          - Current: headingFont='Poppins', bodyFont='DM Sans' (both geometric sans -- fails pairing check)
          - Fix: Change bodyFont to 'Lato' or 'Open Sans' (humanist sans -- passes pairing check)
          - Poppins (geometric) + Lato (humanist) = valid pairing with good contrast

       b. Add a `validateAllThemes()` method that runs each built-in theme through the constraint validators:
          - For each theme, call `validateFontChoice(theme.headingFont)`, `validateFontChoice(theme.bodyFont)`, `validateFontPairing(theme.headingFont, theme.bodyFont)`, `validateTextContrast(theme.textColor, theme.backgroundColor)`, `validatePalette(theme.colorPalette)`
          - Return an array of { themeName, valid, violations }
          - This serves as the validation proof for DC-08

       c. Update `seedBuiltInThemes()` to call `validateAllThemes()` after seeding and log the results.
          - If any theme has violations, throw an error during startup (fail-fast)
          - This ensures themes can never silently break the constraint rules

    2. UPDATE `src/themes/themes.module.ts`:
       - Import ConstraintsModule if needed for validation
       - Or import the validators directly (they are pure functions, no DI needed)

    3. Verify all 5 themes pass validation:
       - dark-professional: Inter (humanist) + Open Sans (humanist) -- actually both humanist, check if this fails!
         - If it fails: change headingFont to 'Montserrat' (geometric) to create contrast
       - light-minimal: Montserrat (geometric) + Inter (humanist) -- valid
       - corporate-blue: Roboto (humanist) + Open Sans (humanist) -- both humanist, may fail!
         - If it fails: change headingFont to 'Poppins' (geometric)
       - creative-warm: Poppins (geometric) + Lato (humanist) -- valid after fix
       - technical-teal: Source Sans Pro (humanist) + Inter (humanist) -- both humanist, may fail!
         - If it fails: change headingFont to 'DM Sans' (geometric)

       CHECK: Read the typography-validator.ts areSameCategory() function carefully. If two humanist fonts fail the check, fix the themes as indicated above. The goal is: ALL 5 themes must pass ALL validators with ZERO violations.

    IMPORTANT: The font pairing validator checks `areSameCategory()`. Humanist + Humanist = same category = invalid. So dark-professional (Inter + Open Sans), corporate-blue (Roboto + Open Sans), and technical-teal (Source Sans Pro + Inter) also need fixing. Fix ALL font pairings so each theme pairs a geometric heading font with a humanist body font (or vice versa).

    Recommended fixes:
    - dark-professional: Montserrat (geometric) + Open Sans (humanist) -- VALID
    - light-minimal: Montserrat (geometric) + Inter (humanist) -- ALREADY VALID
    - corporate-blue: Poppins (geometric) + Open Sans (humanist) -- VALID
    - creative-warm: DM Sans (geometric) + Lato (humanist) -- VALID
    - technical-teal: Nunito Sans (geometric) + Inter (humanist) -- VALID
  </action>
  <verify>
    - `npm run build` succeeds
    - `grep "bodyFont.*Lato\|bodyFont.*Open Sans" src/themes/themes.service.ts` confirms fixed font pairings
    - Start the app and check console output during seedBuiltInThemes -- all 5 themes should log as valid
    - No theme has a violation in the validation output
  </verify>
  <done>All 5 themes pass font pairing validation (each pairs geometric heading + humanist body). Theme validation runs at startup and fails fast if any violations detected.</done>
</task>

<task type="auto">
  <name>Task 2: Enhance themes and constraints API with Swagger docs</name>
  <files>
    src/themes/themes.controller.ts
    src/constraints/constraints.service.ts
  </files>
  <action>
    1. UPDATE `src/themes/themes.controller.ts`:
       - Add @ApiTags('themes') decorator
       - Add proper endpoints:
         - GET /themes -- list all themes, @ApiOperation({ summary: 'List all themes' })
         - GET /themes/:id -- get theme by ID, @ApiOperation({ summary: 'Get theme by ID' })
         - GET /themes/name/:name -- get theme by name, @ApiOperation({ summary: 'Get theme by name' })
         - GET /themes/validate -- run all theme validations and return results, @ApiOperation({ summary: 'Validate all themes against design constraints' })
       - Add @ApiResponse decorators with proper status codes
       - Ensure endpoints return proper JSON (the existing findAll/findOne methods should work)

    2. ADD a constraint validation endpoint to the ConstraintsService or create a ConstraintsController:
       - If no ConstraintsController exists, create a simple one at `src/constraints/constraints.controller.ts`
       - POST /constraints/validate -- accepts a body with slide content + theme, returns validation result
       - @ApiTags('constraints') decorator
       - This endpoint allows programmatic testing of design rules (Success Criteria #3)
       - Input DTO:
         ```typescript
         {
           slide: { title: string, body: string, hasTable?: boolean, tableRows?: number },
           theme: { headingFont: string, bodyFont: string, palette: { text: string, background: string, primary: string, secondary: string, accent: string } },
           layout?: { columns: number, fontSizesUsed: number[], colorsUsed: string[], hasFullBleedText: boolean, overlayOpacity?: number }
         }
         ```
       - Returns: `{ valid: boolean, violations: string[], suggestions: string[] }`

    3. Add the ConstraintsController to ConstraintsModule if created.

    4. `npm run build` to verify compilation.

    5. Test the constraint validation endpoint:
       ```bash
       # Test with forbidden combo (red/green)
       curl -X POST http://localhost:3000/constraints/validate \
         -H "Content-Type: application/json" \
         -d '{"slide":{"title":"Test","body":"- Point 1\n- Point 2"},"theme":{"headingFont":"Inter","bodyFont":"Open Sans","palette":{"text":"#ff0000","background":"#00ff00","primary":"#333","secondary":"#666","accent":"#999"}}}'

       # Test with too many bullets
       curl -X POST http://localhost:3000/constraints/validate \
         -H "Content-Type: application/json" \
         -d '{"slide":{"title":"Test","body":"- One\n- Two\n- Three\n- Four\n- Five\n- Six\n- Seven"},"theme":{"headingFont":"Montserrat","bodyFont":"Inter","palette":{"text":"#1e293b","background":"#ffffff","primary":"#333","secondary":"#666","accent":"#999"}}}'

       # Test with banned font
       curl -X POST http://localhost:3000/constraints/validate \
         -H "Content-Type: application/json" \
         -d '{"slide":{"title":"Test","body":"Content"},"theme":{"headingFont":"Comic Sans","bodyFont":"Papyrus","palette":{"text":"#000","background":"#fff","primary":"#333","secondary":"#666","accent":"#999"}}}'
       ```
  </action>
  <verify>
    - `npm run build` succeeds
    - `curl http://localhost:3000/themes` returns 5 themes
    - `curl http://localhost:3000/themes/validate` returns all 5 themes as valid
    - Constraint validation endpoint rejects red/green combo, 7 bullets, and Comic Sans with specific violation messages
    - Swagger at /api/docs shows themes and constraints endpoints
  </verify>
  <done>Theme and constraint API endpoints documented in Swagger. Theme validation endpoint proves all 5 themes pass. Constraint validation endpoint accepts slide + theme and returns violations.</done>
</task>

</tasks>

<verification>
1. `npm run build` -- no TypeScript errors
2. `curl http://localhost:3000/themes` -- returns 5 themes
3. `curl http://localhost:3000/themes/validate` -- all 5 themes pass with zero violations
4. `curl -X POST http://localhost:3000/constraints/validate` with red/green combo -- returns violations
5. `curl -X POST http://localhost:3000/constraints/validate` with 7 bullets -- returns density violation
6. `curl -X POST http://localhost:3000/constraints/validate` with Comic Sans -- returns banned font violation
7. Swagger at /api/docs shows themes and constraints tags
</verification>

<success_criteria>
- DC-08: 5 built-in themes available via API, all with validated palettes and font pairings
- All theme font pairings use cross-category fonts (geometric + humanist)
- Theme validation runs at startup and fails fast on violations
- Constraint validation endpoint enables programmatic testing (Phase 1 Success Criteria #3)
- Swagger documentation covers themes and constraints endpoints
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation/01-05-SUMMARY.md`
</output>
