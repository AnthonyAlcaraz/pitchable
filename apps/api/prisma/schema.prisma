generator client {
  provider = "prisma-client"
  output   = "../generated/prisma"
}

datasource db {
  provider = "postgresql"
}

model User {
  id                 String              @id @default(uuid()) @db.Uuid
  email              String              @unique
  passwordHash       String
  name               String
  role               UserRole            @default(USER)
  creditBalance      Int                 @default(0)
  tier               UserTier            @default(FREE)
  refreshTokenHash   String?
  stripeCustomerId   String?             @unique
  decksThisMonth     Int                 @default(0)
  monthResetAt       DateTime            @default(now())
  registrationIp     String?
  lastLoginIp        String?
  lastLoginAt        DateTime?
  onboardingCompleted Boolean            @default(false)
  failedLoginAttempts Int                @default(0)
  lockedUntil        DateTime?
  passwordResetToken String?
  passwordResetUsedAt DateTime?
  createdAt          DateTime            @default(now())
  updatedAt          DateTime            @updatedAt
  apiKeys            ApiKey[]
  creditReservations CreditReservation[]
  creditTransactions CreditTransaction[]
  documents          Document[]
  graphMapping       GraphMapping?
  feedbackEntries    FeedbackEntry[]
  pitchBriefs        PitchBrief[]
  pitchLenses        PitchLens[]
  presentations      Presentation[]
  subscription       Subscription?
  figmaIntegration   FigmaIntegration?
  figmaTemplates     FigmaTemplate[]
  figmaWebhooks      FigmaWebhook[]

  @@index([email])
}

model Presentation {
  id               String             @id @default(uuid()) @db.Uuid
  title            String
  description      String?
  sourceContent    String
  presentationType PresentationType
  status           PresentationStatus @default(DRAFT)
  themeId          String             @db.Uuid
  logoUrl          String?
  imageCount       Int                @default(0)
  pitchLensId      String?            @db.Uuid
  briefId          String?            @db.Uuid
  forkedFromId     String?            @db.Uuid
  isPublic         Boolean            @default(false)
  featured         Boolean            @default(false)
  viewCount        Int                @default(0)
  forkCount        Int                @default(0)
  publishedAt      DateTime?
  userId           String             @db.Uuid
  createdAt        DateTime           @default(now())
  updatedAt        DateTime           @updatedAt
  chatMessages     ChatMessage[]
  exportJobs       ExportJob[]
  brief            PitchBrief?        @relation(fields: [briefId], references: [id])
  forkedFrom       Presentation?      @relation("PresentationFork", fields: [forkedFromId], references: [id])
  forks            Presentation[]     @relation("PresentationFork")
  pitchLens        PitchLens?         @relation(fields: [pitchLensId], references: [id])
  theme            Theme              @relation(fields: [themeId], references: [id])
  user             User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  views            PresentationView[]
  slides           Slide[]
  draftSlides      DraftSlide[]

  @@index([userId])
  @@index([status])
  @@index([pitchLensId])
  @@index([briefId])
  @@index([forkedFromId])
  @@index([isPublic, status])
  @@index([isPublic, viewCount])
  @@index([isPublic, featured, publishedAt])
}

model Slide {
  id             String       @id @default(uuid()) @db.Uuid
  presentationId String       @db.Uuid
  slideNumber    Int
  title          String
  body           String
  speakerNotes   String?
  slideType      SlideType
  imageUrl       String?
  imageLocalPath String?
  imagePrompt    String?
  imageSource    ImageSource @default(AI_GENERATED)
  figmaFileKey   String?
  figmaNodeId    String?
  figmaNodeName  String?
  previewUrl     String?
  sectionLabel      String?
  contentHash       String?
  createdAt         DateTime     @default(now())
  updatedAt         DateTime     @default(now()) @updatedAt
  figmaLastSyncAt   DateTime?
  figmaSyncVersion  Int          @default(0)
  imageJobs         ImageJob[]
  slideSources      SlideSource[]
  presentation      Presentation @relation(fields: [presentationId], references: [id], onDelete: Cascade)

  @@index([presentationId, createdAt])
}

model Theme {
  id              String         @id @default(uuid()) @db.Uuid
  name            String         @unique
  displayName     String
  description     String
  isBuiltIn       Boolean        @default(true)
  primaryColor    String
  secondaryColor  String
  accentColor     String
  backgroundColor String
  textColor       String
  headingFont     String
  bodyFont        String
  colorPalette    Json
  createdAt       DateTime       @default(now())
  presentations   Presentation[]
}

model CreditTransaction {
  id           String       @id @default(uuid()) @db.Uuid
  userId       String       @db.Uuid
  amount       Int
  reason       CreditReason
  referenceId  String?
  balanceAfter Int
  createdAt    DateTime     @default(now())
  user         User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model Subscription {
  id                   String    @id @default(uuid()) @db.Uuid
  userId               String    @unique @db.Uuid
  stripeSubscriptionId String?   @unique
  tier                 UserTier  @default(FREE)
  status               String    @default("active")
  currentPeriodStart   DateTime?
  currentPeriodEnd     DateTime?
  cancelAtPeriodEnd    Boolean   @default(false)
  createdAt            DateTime  @default(now())
  updatedAt            DateTime  @updatedAt
  user                 User      @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model CreditReservation {
  id          String       @id @default(uuid()) @db.Uuid
  userId      String       @db.Uuid
  amount      Int
  reason      CreditReason
  referenceId String?
  status      String       @default("reserved")
  expiresAt   DateTime
  createdAt   DateTime     @default(now())
  resolvedAt  DateTime?
  user        User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, status])
}

model ExportJob {
  id             String       @id @default(uuid()) @db.Uuid
  presentationId String       @db.Uuid
  format         ExportFormat
  status         JobStatus    @default(QUEUED)
  fileUrl        String?
  errorMessage   String?
  createdAt      DateTime     @default(now())
  completedAt    DateTime?
  presentation   Presentation @relation(fields: [presentationId], references: [id], onDelete: Cascade)

  @@index([presentationId])
  @@index([presentationId, format, status])
}

model DraftSlide {
  id             String       @id @default(uuid()) @db.Uuid
  presentationId String       @db.Uuid
  slideNumber    Int
  title          String
  body           String
  speakerNotes   String?
  slideType      SlideType
  imagePrompt    String?
  sectionLabel   String?
  contentHash    String?
  createdAt      DateTime     @default(now())
  presentation   Presentation @relation(fields: [presentationId], references: [id], onDelete: Cascade)

  @@index([presentationId])
}

model SlideSource {
  id        String        @id @default(uuid()) @db.Uuid
  slideId   String        @db.Uuid
  chunkId   String        @db.Uuid
  relevance Float         @default(0)
  createdAt DateTime      @default(now())
  slide     Slide         @relation(fields: [slideId], references: [id], onDelete: Cascade)
  chunk     DocumentChunk @relation(fields: [chunkId], references: [id], onDelete: Cascade)

  @@unique([slideId, chunkId])
  @@index([slideId])
  @@index([chunkId])
}

model ImageJob {
  id           String    @id @default(uuid()) @db.Uuid
  slideId      String    @db.Uuid
  status       JobStatus @default(QUEUED)
  replicateId  String?
  prompt       String
  resultUrl    String?
  imgurUrl     String?
  creditsUsed  Int       @default(1)
  errorMessage String?
  createdAt    DateTime  @default(now())
  completedAt  DateTime?
  slide        Slide     @relation(fields: [slideId], references: [id], onDelete: Cascade)

  @@index([slideId])
}

model Document {
  id           String             @id @default(uuid()) @db.Uuid
  userId       String             @db.Uuid
  title        String
  sourceType   DocumentSourceType
  mimeType     String?
  fileSize     Int?
  s3Key        String?
  sourceUrl    String?
  status       DocumentStatus     @default(UPLOADED)
  chunkCount   Int                @default(0)
  errorMessage String?
  contentHash  String?
  processedAt  DateTime?
  createdAt    DateTime           @default(now())
  updatedAt    DateTime           @updatedAt
  briefId      String?            @db.Uuid
  brief        PitchBrief?        @relation(fields: [briefId], references: [id])
  user         User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  chunks       DocumentChunk[]

  @@index([userId])
  @@index([status])
  @@index([briefId])
  @@index([userId, contentHash])
}

model GraphMapping {
  id        String   @id @default(uuid()) @db.Uuid
  userId    String   @unique @db.Uuid
  graphName String   @map("tenantId")
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("EdgeQuakeMapping")
}

model DocumentChunk {
  id            String                 @id @default(uuid()) @db.Uuid
  documentId    String                 @db.Uuid
  content       String
  heading       String?
  headingLevel  Int                    @default(0)
  chunkIndex    Int
  metadata      Json                   @default("{}")
  contentHash   String?
  approvalScore Float                  @default(0)
  usageCount    Int                    @default(0)
  createdAt     DateTime               @default(now())
  document      Document               @relation(fields: [documentId], references: [id], onDelete: Cascade)
  slideSources  SlideSource[]

  @@index([documentId])
  @@index([contentHash])
}

model ChatMessage {
  id             String       @id @default(uuid()) @db.Uuid
  presentationId String       @db.Uuid
  role           String
  content        String
  messageType    String       @default("text")
  metadata       Json         @default("{}")
  createdAt      DateTime     @default(now())
  presentation   Presentation @relation(fields: [presentationId], references: [id], onDelete: Cascade)

  @@index([presentationId])
}

model FeedbackEntry {
  id               String   @id @default(uuid()) @db.Uuid
  userId           String   @db.Uuid
  presentationId   String?  @db.Uuid
  slideId          String?  @db.Uuid
  type             String
  category         String
  originalContent  String?
  correctedContent String?
  rule             String?
  createdAt        DateTime @default(now())
  user             User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([userId, type])
}

model PitchLens {
  id                  String         @id @default(uuid()) @db.Uuid
  userId              String         @db.Uuid
  name                String
  description         String?
  audienceType        AudienceType
  pitchGoal           PitchGoal
  industry            String
  companyStage        CompanyStage
  toneStyle           ToneStyle
  technicalLevel      TechnicalLevel
  selectedFramework   StoryFramework
  frameworkOverridden Boolean        @default(false)
  deckArchetype       DeckArchetype?
  customGuidance      String?
  preferredSlideRange Json?
  isDefault           Boolean        @default(false)
  isPublic            Boolean        @default(false)
  createdAt           DateTime       @default(now())
  updatedAt           DateTime       @updatedAt
  imageFrequency      Int            @default(5)
  imageLayout         ImageLayout    @default(BACKGROUND)
  maxBulletsPerSlide  Int?
  maxWordsPerSlide    Int?
  maxTableRows        Int?
  showSectionLabels   Boolean        @default(false)
  showOutlineSlide    Boolean        @default(false)
  useCount            Int            @default(0)
  rating              Float          @default(0)
  ratingCount         Int            @default(0)
  clonedFromId        String?        @db.Uuid
  figmaFileKey        String?
  figmaAccessToken    String?
  figmaTemplateId     String?        @db.Uuid
  clonedFrom          PitchLens?     @relation("PitchLensClone", fields: [clonedFromId], references: [id])
  clones              PitchLens[]    @relation("PitchLensClone")
  figmaTemplate       FigmaTemplate? @relation("PitchLensTemplate", fields: [figmaTemplateId], references: [id])
  briefLenses         BriefLens[]
  user                User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  presentations       Presentation[]

  @@index([userId])
  @@index([userId, isDefault])
  @@index([isPublic])
  @@index([isPublic, useCount])
  @@index([isPublic, rating])
}

model PitchBrief {
  id                   String         @id @default(uuid()) @db.Uuid
  userId               String         @db.Uuid
  name                 String
  description          String?
  graphName            String?        @map("edgequakeWorkspaceId")
  documentCount        Int            @default(0)
  entityCount          Int            @default(0)
  status               BriefStatus    @default(EMPTY)
  createdAt            DateTime       @default(now())
  updatedAt            DateTime       @updatedAt
  briefLenses          BriefLens[]
  documents            Document[]
  user                 User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  presentations        Presentation[]

  @@index([userId])
}

model BriefLens {
  id        String     @id @default(uuid()) @db.Uuid
  briefId   String     @db.Uuid
  lensId    String     @db.Uuid
  createdAt DateTime   @default(now())
  brief     PitchBrief @relation(fields: [briefId], references: [id], onDelete: Cascade)
  lens      PitchLens  @relation(fields: [lensId], references: [id], onDelete: Cascade)

  @@unique([briefId, lensId])
  @@index([briefId])
  @@index([lensId])
}

model RegistrationIpLog {
  id        String   @id @default(uuid()) @db.Uuid
  ip        String
  userId    String   @db.Uuid
  createdAt DateTime @default(now())

  @@index([ip])
  @@index([ip, createdAt])
}

model ApiKey {
  id         String    @id @default(uuid()) @db.Uuid
  userId     String    @db.Uuid
  name       String
  keyHash    String    @unique
  keyPrefix  String
  scopes     String[]
  rateLimit  Int       @default(60)
  lastUsedAt DateTime?
  expiresAt  DateTime?
  isRevoked  Boolean   @default(false)
  createdAt  DateTime  @default(now())
  user       User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([keyPrefix])
  @@index([userId])
}

model FigmaIntegration {
  id              String   @id @default(uuid()) @db.Uuid
  userId          String   @unique @db.Uuid
  accessToken     String
  figmaUserId     String?
  figmaUserName   String?
  isValid         Boolean  @default(true)
  lastValidatedAt DateTime?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}



model FigmaTemplate {
  id            String                 @id @default(uuid()) @db.Uuid
  userId        String                 @db.Uuid
  name          String
  description   String?
  figmaFileKey  String
  figmaFileName String?
  thumbnailUrl  String?
  isPublic      Boolean                @default(false)
  createdAt     DateTime               @default(now())
  updatedAt     DateTime               @updatedAt
  user          User                   @relation(fields: [userId], references: [id], onDelete: Cascade)
  mappings      FigmaTemplateMapping[]
  pitchLenses   PitchLens[]            @relation("PitchLensTemplate")

  @@index([userId])
  @@index([isPublic])
}

model FigmaTemplateMapping {
  id            String        @id @default(uuid()) @db.Uuid
  templateId    String        @db.Uuid
  slideType     SlideType
  figmaNodeId   String
  figmaNodeName String?
  thumbnailUrl  String?
  createdAt     DateTime      @default(now())
  template      FigmaTemplate @relation(fields: [templateId], references: [id], onDelete: Cascade)

  @@unique([templateId, slideType])
  @@index([templateId])
}

model PresentationView {
  id             String       @id @default(uuid()) @db.Uuid
  presentationId String       @db.Uuid
  viewerIp       String?
  viewerUserId   String?      @db.Uuid
  referrer       String?
  createdAt      DateTime     @default(now())
  presentation   Presentation @relation(fields: [presentationId], references: [id], onDelete: Cascade)

  @@index([presentationId])
  @@index([presentationId, createdAt])
}

enum UserRole {
  USER
  ADMIN
}

enum UserTier {
  FREE
  STARTER
  PRO
  ENTERPRISE
}

enum PresentationType {
  STANDARD
  VC_PITCH
  TECHNICAL
  EXECUTIVE
}

enum PresentationStatus {
  DRAFT
  PROCESSING
  REVIEWING
  COMPLETED
  FAILED
}

enum SlideType {
  TITLE
  PROBLEM
  SOLUTION
  ARCHITECTURE
  PROCESS
  COMPARISON
  DATA_METRICS
  CTA
  CONTENT
  QUOTE
  VISUAL_HUMOR
  OUTLINE
  TEAM
  TIMELINE
  SECTION_DIVIDER
  METRICS_HIGHLIGHT
  FEATURE_GRID
  PRODUCT_SHOWCASE
  LOGO_WALL
  MARKET_SIZING
  SPLIT_STATEMENT
}

enum CreditReason {
  PURCHASE
  IMAGE_GENERATION
  DECK_GENERATION
  DECK_EXPORT
  MONTHLY_ALLOWANCE
  ADMIN_GRANT
  SUBSCRIPTION_RENEWAL
  API_GENERATION
  ENTITY_EXTRACTION
  OUTLINE_GENERATION
  SLIDE_MODIFICATION
  CHAT_MESSAGE
  WEBSITE_CRAWL
}

enum ExportFormat {
  PPTX
  PDF
  GOOGLE_SLIDES
  REVEAL_JS
  FIGMA
}

enum JobStatus {
  QUEUED
  PROCESSING
  COMPLETED
  FAILED
  PENDING_RETRY
}

enum DocumentStatus {
  UPLOADED
  PARSING
  EMBEDDING
  READY
  ERROR
}

enum DocumentSourceType {
  FILE
  TEXT
  URL
}

enum AudienceType {
  INVESTORS
  CUSTOMERS
  EXECUTIVES
  TEAM
  CONFERENCE
  BOARD
  TECHNICAL
}

enum PitchGoal {
  RAISE_FUNDING
  SELL_PRODUCT
  GET_BUYIN
  EDUCATE
  INSPIRE
  REPORT_RESULTS
}

enum ToneStyle {
  FORMAL
  CONVERSATIONAL
  BOLD
  INSPIRATIONAL
  ANALYTICAL
  STORYTELLING
}

enum CompanyStage {
  IDEA
  MVP
  GROWTH
  ENTERPRISE
}

enum TechnicalLevel {
  NON_TECHNICAL
  SEMI_TECHNICAL
  TECHNICAL
  HIGHLY_TECHNICAL
}

enum StoryFramework {
  HEROS_JOURNEY
  MINTO_PYRAMID
  RESONATE
  PAS
  BAB
  STAR
  PIXAR_PITCH
  MCKINSEY_SCR
  POPP
  KAWASAKI_10_20_30
  WHAT_SO_WHAT_NOW_WHAT
  TALK_LIKE_TED
  WORLD_IS_BROKEN
  PRODUCT_FIRST
  FOUNDER_INSIGHT
}

enum ImageLayout {
  BACKGROUND
  RIGHT
}

enum ImageSource {
  AI_GENERATED
  FIGMA
  UPLOADED
}

enum DeckArchetype {
  INVESTOR_PITCH
  SALES_DECK
  STRATEGY_BRIEF
  KEYNOTE
  PRODUCT_LAUNCH
  BOARD_UPDATE
  TECHNICAL_DEEP_DIVE
  CULTURE_DECK
  TRAINING_WORKSHOP
  CASE_STUDY
  PRE_SEED_PITCH
}

enum BriefStatus {
  EMPTY
  PROCESSING
  READY
  ERROR
}

model FigmaWebhook {
  id          String    @id @default(uuid()) @db.Uuid
  userId      String    @db.Uuid
  fileKey     String
  webhookId   String    @unique
  passcode    String
  isActive    Boolean   @default(true)
  lastEventAt DateTime?
  createdAt   DateTime  @default(now())
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([fileKey])
  @@index([userId])
}
