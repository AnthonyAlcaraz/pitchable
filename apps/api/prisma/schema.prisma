generator client {
  provider = "prisma-client"
  output   = "../generated/prisma"
}

datasource db {
  provider = "postgresql"
}

model User {
  id                 String              @id @default(uuid()) @db.Uuid
  email              String              @unique
  passwordHash       String
  name               String
  role               UserRole            @default(USER)
  creditBalance      Int                 @default(0)
  tier               UserTier            @default(FREE)
  refreshTokenHash   String?
  stripeCustomerId   String?             @unique
  decksThisMonth     Int                 @default(0)
  monthResetAt       DateTime            @default(now())
  registrationIp     String?
  lastLoginIp        String?
  lastLoginAt        DateTime?
  onboardingCompleted Boolean            @default(false)
  failedLoginAttempts Int                @default(0)
  lockedUntil        DateTime?
  passwordResetToken String?
  passwordResetUsedAt DateTime?
  createdAt          DateTime            @default(now())
  updatedAt          DateTime            @updatedAt
  apiKeys            ApiKey[]
  creditReservations CreditReservation[]
  creditTransactions CreditTransaction[]
  documents          Document[]
  edgequakeMapping   EdgeQuakeMapping?
  feedbackEntries    FeedbackEntry[]
  pitchBriefs        PitchBrief[]
  pitchLenses        PitchLens[]
  presentations      Presentation[]
  subscription       Subscription?

  @@index([email])
}

model Presentation {
  id               String             @id @default(uuid()) @db.Uuid
  title            String
  description      String?
  sourceContent    String
  presentationType PresentationType
  status           PresentationStatus @default(DRAFT)
  themeId          String             @db.Uuid
  imageCount       Int                @default(0)
  pitchLensId      String?            @db.Uuid
  briefId          String?            @db.Uuid
  forkedFromId     String?            @db.Uuid
  isPublic         Boolean            @default(false)
  featured         Boolean            @default(false)
  viewCount        Int                @default(0)
  forkCount        Int                @default(0)
  publishedAt      DateTime?
  userId           String             @db.Uuid
  createdAt        DateTime           @default(now())
  updatedAt        DateTime           @updatedAt
  chatMessages     ChatMessage[]
  exportJobs       ExportJob[]
  brief            PitchBrief?        @relation(fields: [briefId], references: [id])
  forkedFrom       Presentation?      @relation("PresentationFork", fields: [forkedFromId], references: [id])
  forks            Presentation[]     @relation("PresentationFork")
  pitchLens        PitchLens?         @relation(fields: [pitchLensId], references: [id])
  theme            Theme              @relation(fields: [themeId], references: [id])
  user             User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  views            PresentationView[]
  slides           Slide[]

  @@index([userId])
  @@index([status])
  @@index([pitchLensId])
  @@index([briefId])
  @@index([forkedFromId])
  @@index([isPublic, status])
  @@index([isPublic, viewCount])
  @@index([isPublic, featured, publishedAt])
}

model Slide {
  id             String       @id @default(uuid()) @db.Uuid
  presentationId String       @db.Uuid
  slideNumber    Int
  title          String
  body           String
  speakerNotes   String?
  slideType      SlideType
  imageUrl       String?
  imageLocalPath String?
  imagePrompt    String?
  createdAt      DateTime     @default(now())
  imageJobs      ImageJob[]
  presentation   Presentation @relation(fields: [presentationId], references: [id], onDelete: Cascade)

  @@index([presentationId])
}

model Theme {
  id              String         @id @default(uuid()) @db.Uuid
  name            String         @unique
  displayName     String
  description     String
  isBuiltIn       Boolean        @default(true)
  primaryColor    String
  secondaryColor  String
  accentColor     String
  backgroundColor String
  textColor       String
  headingFont     String
  bodyFont        String
  colorPalette    Json
  createdAt       DateTime       @default(now())
  presentations   Presentation[]
}

model CreditTransaction {
  id           String       @id @default(uuid()) @db.Uuid
  userId       String       @db.Uuid
  amount       Int
  reason       CreditReason
  referenceId  String?
  balanceAfter Int
  createdAt    DateTime     @default(now())
  user         User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model Subscription {
  id                   String    @id @default(uuid()) @db.Uuid
  userId               String    @unique @db.Uuid
  stripeSubscriptionId String?   @unique
  tier                 UserTier  @default(FREE)
  status               String    @default("active")
  currentPeriodStart   DateTime?
  currentPeriodEnd     DateTime?
  cancelAtPeriodEnd    Boolean   @default(false)
  createdAt            DateTime  @default(now())
  updatedAt            DateTime  @updatedAt
  user                 User      @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model CreditReservation {
  id          String       @id @default(uuid()) @db.Uuid
  userId      String       @db.Uuid
  amount      Int
  reason      CreditReason
  referenceId String?
  status      String       @default("reserved")
  expiresAt   DateTime
  createdAt   DateTime     @default(now())
  resolvedAt  DateTime?
  user        User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, status])
}

model ExportJob {
  id             String       @id @default(uuid()) @db.Uuid
  presentationId String       @db.Uuid
  format         ExportFormat
  status         JobStatus    @default(QUEUED)
  fileUrl        String?
  errorMessage   String?
  createdAt      DateTime     @default(now())
  completedAt    DateTime?
  presentation   Presentation @relation(fields: [presentationId], references: [id], onDelete: Cascade)

  @@index([presentationId])
}

model ImageJob {
  id           String    @id @default(uuid()) @db.Uuid
  slideId      String    @db.Uuid
  status       JobStatus @default(QUEUED)
  replicateId  String?
  prompt       String
  resultUrl    String?
  imgurUrl     String?
  creditsUsed  Int       @default(1)
  errorMessage String?
  createdAt    DateTime  @default(now())
  completedAt  DateTime?
  slide        Slide     @relation(fields: [slideId], references: [id], onDelete: Cascade)

  @@index([slideId])
}

model Document {
  id           String             @id @default(uuid()) @db.Uuid
  userId       String             @db.Uuid
  title        String
  sourceType   DocumentSourceType
  mimeType     String?
  fileSize     Int?
  s3Key        String?
  sourceUrl    String?
  status       DocumentStatus     @default(UPLOADED)
  chunkCount   Int                @default(0)
  errorMessage String?
  processedAt  DateTime?
  createdAt    DateTime           @default(now())
  updatedAt    DateTime           @updatedAt
  briefId      String?            @db.Uuid
  brief        PitchBrief?        @relation(fields: [briefId], references: [id])
  user         User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  chunks       DocumentChunk[]

  @@index([userId])
  @@index([status])
  @@index([briefId])
}

model EdgeQuakeMapping {
  id          String   @id @default(uuid()) @db.Uuid
  userId      String   @unique @db.Uuid
  tenantId    String
  workspaceId String
  createdAt   DateTime @default(now())
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model DocumentChunk {
  id           String                 @id @default(uuid()) @db.Uuid
  documentId   String                 @db.Uuid
  content      String
  heading      String?
  headingLevel Int                    @default(0)
  chunkIndex   Int
  embedding    Unsupported("vector")?
  metadata     Json                   @default("{}")
  createdAt    DateTime               @default(now())
  document     Document               @relation(fields: [documentId], references: [id], onDelete: Cascade)

  @@index([documentId])
}

model ChatMessage {
  id             String       @id @default(uuid()) @db.Uuid
  presentationId String       @db.Uuid
  role           String
  content        String
  messageType    String       @default("text")
  metadata       Json         @default("{}")
  createdAt      DateTime     @default(now())
  presentation   Presentation @relation(fields: [presentationId], references: [id], onDelete: Cascade)

  @@index([presentationId])
}

model FeedbackEntry {
  id               String   @id @default(uuid()) @db.Uuid
  userId           String   @db.Uuid
  presentationId   String?  @db.Uuid
  slideId          String?  @db.Uuid
  type             String
  category         String
  originalContent  String?
  correctedContent String?
  rule             String?
  createdAt        DateTime @default(now())
  user             User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([userId, type])
}

model PitchLens {
  id                  String         @id @default(uuid()) @db.Uuid
  userId              String         @db.Uuid
  name                String
  description         String?
  audienceType        AudienceType
  pitchGoal           PitchGoal
  industry            String
  companyStage        CompanyStage
  toneStyle           ToneStyle
  technicalLevel      TechnicalLevel
  selectedFramework   StoryFramework
  frameworkOverridden Boolean        @default(false)
  deckArchetype       DeckArchetype?
  customGuidance      String?
  preferredSlideRange Json?
  isDefault           Boolean        @default(false)
  isPublic            Boolean        @default(false)
  createdAt           DateTime       @default(now())
  updatedAt           DateTime       @updatedAt
  imageFrequency      Int            @default(4)
  imageLayout         ImageLayout    @default(RIGHT)
  maxBulletsPerSlide  Int?
  maxWordsPerSlide    Int?
  maxTableRows        Int?
  briefLenses         BriefLens[]
  user                User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  presentations       Presentation[]

  @@index([userId])
  @@index([userId, isDefault])
  @@index([isPublic])
}

model PitchBrief {
  id                   String         @id @default(uuid()) @db.Uuid
  userId               String         @db.Uuid
  name                 String
  description          String?
  edgequakeWorkspaceId String?
  documentCount        Int            @default(0)
  entityCount          Int            @default(0)
  status               BriefStatus    @default(EMPTY)
  createdAt            DateTime       @default(now())
  updatedAt            DateTime       @updatedAt
  briefLenses          BriefLens[]
  documents            Document[]
  user                 User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  presentations        Presentation[]

  @@index([userId])
}

model BriefLens {
  id        String     @id @default(uuid()) @db.Uuid
  briefId   String     @db.Uuid
  lensId    String     @db.Uuid
  createdAt DateTime   @default(now())
  brief     PitchBrief @relation(fields: [briefId], references: [id], onDelete: Cascade)
  lens      PitchLens  @relation(fields: [lensId], references: [id], onDelete: Cascade)

  @@unique([briefId, lensId])
  @@index([briefId])
  @@index([lensId])
}

model RegistrationIpLog {
  id        String   @id @default(uuid()) @db.Uuid
  ip        String
  userId    String   @db.Uuid
  createdAt DateTime @default(now())

  @@index([ip])
  @@index([ip, createdAt])
}

model ApiKey {
  id         String    @id @default(uuid()) @db.Uuid
  userId     String    @db.Uuid
  name       String
  keyHash    String    @unique
  keyPrefix  String
  scopes     String[]
  rateLimit  Int       @default(60)
  lastUsedAt DateTime?
  expiresAt  DateTime?
  isRevoked  Boolean   @default(false)
  createdAt  DateTime  @default(now())
  user       User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([keyPrefix])
  @@index([userId])
}

model PresentationView {
  id             String       @id @default(uuid()) @db.Uuid
  presentationId String       @db.Uuid
  viewerIp       String?
  viewerUserId   String?      @db.Uuid
  referrer       String?
  createdAt      DateTime     @default(now())
  presentation   Presentation @relation(fields: [presentationId], references: [id], onDelete: Cascade)

  @@index([presentationId])
  @@index([presentationId, createdAt])
}

enum UserRole {
  USER
  ADMIN
}

enum UserTier {
  FREE
  STARTER
  PRO
  ENTERPRISE
}

enum PresentationType {
  STANDARD
  VC_PITCH
  TECHNICAL
  EXECUTIVE
}

enum PresentationStatus {
  DRAFT
  PROCESSING
  COMPLETED
  FAILED
}

enum SlideType {
  TITLE
  PROBLEM
  SOLUTION
  ARCHITECTURE
  PROCESS
  COMPARISON
  DATA_METRICS
  CTA
  CONTENT
  QUOTE
  VISUAL_HUMOR
}

enum CreditReason {
  PURCHASE
  IMAGE_GENERATION
  DECK_GENERATION
  DECK_EXPORT
  MONTHLY_ALLOWANCE
  ADMIN_GRANT
  SUBSCRIPTION_RENEWAL
  API_GENERATION
}

enum ExportFormat {
  PPTX
  PDF
  GOOGLE_SLIDES
  REVEAL_JS
}

enum JobStatus {
  QUEUED
  PROCESSING
  COMPLETED
  FAILED
}

enum DocumentStatus {
  UPLOADED
  PARSING
  EMBEDDING
  READY
  ERROR
}

enum DocumentSourceType {
  FILE
  TEXT
  URL
}

enum AudienceType {
  INVESTORS
  CUSTOMERS
  EXECUTIVES
  TEAM
  CONFERENCE
  BOARD
  TECHNICAL
}

enum PitchGoal {
  RAISE_FUNDING
  SELL_PRODUCT
  GET_BUYIN
  EDUCATE
  INSPIRE
  REPORT_RESULTS
}

enum ToneStyle {
  FORMAL
  CONVERSATIONAL
  BOLD
  INSPIRATIONAL
  ANALYTICAL
  STORYTELLING
}

enum CompanyStage {
  IDEA
  MVP
  GROWTH
  ENTERPRISE
}

enum TechnicalLevel {
  NON_TECHNICAL
  SEMI_TECHNICAL
  TECHNICAL
  HIGHLY_TECHNICAL
}

enum StoryFramework {
  HEROS_JOURNEY
  MINTO_PYRAMID
  RESONATE
  PAS
  BAB
  STAR
  PIXAR_PITCH
  MCKINSEY_SCR
  POPP
  KAWASAKI_10_20_30
  WHAT_SO_WHAT_NOW_WHAT
  TALK_LIKE_TED
}

enum ImageLayout {
  BACKGROUND
  RIGHT
}

enum DeckArchetype {
  INVESTOR_PITCH
  SALES_DECK
  STRATEGY_BRIEF
  KEYNOTE
  PRODUCT_LAUNCH
  BOARD_UPDATE
  TECHNICAL_DEEP_DIVE
  CULTURE_DECK
  TRAINING_WORKSHOP
  CASE_STUDY
}

enum BriefStatus {
  EMPTY
  PROCESSING
  READY
  ERROR
}
